<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>改密碼</title>
  <style>
    body{font-family:system-ui,Segoe UI,Microsoft JhengHei,Arial;max-width:520px;margin:48px auto;padding:0 16px}
    h1{margin:0 0 14px}
    .card{border:1px solid #ddd;border-radius:12px;padding:18px}
    input,button{width:100%;padding:10px 12px;margin:8px 0;font-size:16px;box-sizing:border-box}
    button{cursor:pointer}
    .err{color:#c00;min-height:20px}
    .ok{color:#080;min-height:20px}
  </style>
</head>
<body>
  <h1>改密碼</h1>
  <div class="card">
    <div class="err" id="err"></div>
    <div class="ok" id="ok"></div>
    <input id="old" placeholder="舊密碼" type="password" autocomplete="current-password"/>
    <input id="nw" placeholder="新密碼" type="password" autocomplete="new-password"/>
    <input id="nw2" placeholder="新密碼（再輸入一次）" type="password" autocomplete="new-password"/>
    <button id="btn">確認修改</button>
  </div>

  <script type="module">
    import { me, changePassword, clearToken } from "./api.js";
    const $err = document.querySelector("#err");
    const $ok = document.querySelector("#ok");
    const $old = document.querySelector("#old");
    const $nw = document.querySelector("#nw");
    const $nw2 = document.querySelector("#nw2");
    const $btn = document.querySelector("#btn");

    (async () => {
      try { await me(); } catch (e) { clearToken(); location.href="./login.html"; }
    })();

    async function doChange() {
      $err.textContent = "";
      $ok.textContent = "";
      if ($nw.value !== $nw2.value) { $err.textContent = "兩次新密碼不一致"; return; }
      $btn.disabled = true;
      try {
        await changePassword($old.value, $nw.value);
        $ok.textContent = "已修改，將回到主頁";
        setTimeout(() => location.href="./app.html", 600);
      } catch (e) {
        $err.textContent = e?.data?.error || e.message || "修改失敗";
      } finally {
        $btn.disabled = false;
      }
    }
    $btn.addEventListener("click", doChange);
  </script>
</body>
</html>
