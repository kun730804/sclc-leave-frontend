<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>月曆 - SCLC DB</title>

  <!-- FullCalendar (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <style>
    body{font-family: system-ui, -apple-system, "Microsoft JhengHei", Arial, sans-serif; margin:0; padding:0;}
    header{display:flex; gap:10px; align-items:center; padding:16px 18px; border-bottom:1px solid #eee;}
    header h1{font-size:18px; margin:0; flex:1}
    .btn{padding:8px 10px; border:1px solid #ddd; background:#fff; cursor:pointer; border-radius:6px;}
    .btn:hover{background:#fafafa}
    .pill{font-size:12px; padding:4px 8px; background:#f1f3f4; border-radius:999px}
    #wrap{padding:18px;}
    #calendar{max-width:1100px; margin:0 auto;}
    #status{max-width:1100px; margin:10px auto 0; color:#555; font-size:13px; white-space:pre-wrap}
    .bar{max-width:1100px; margin:0 auto 12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .bar .spacer{flex:1}
    .hint{color:#666; font-size:12px}
  </style>
</head>
<body>
  <header>
    <h1>月曆</h1>
    <span id="me" class="pill">讀取中…</span>
    <button class="btn" id="btnChangePw">改密碼</button>
    <button class="btn" id="btnAdmin" hidden>Admin</button>
    <button class="btn" id="btnLogout">登出</button>
  </header>

  <div id="wrap">
    <div class="bar">
      <button class="btn" id="btnRefresh">重新載入</button>
      <button class="btn" id="btnSyncLeave" hidden>同步排假（管理者）</button>
      <button class="btn" id="btnSyncOT" hidden>同步加班（管理者）</button>
      <span class="spacer"></span>
      <span class="hint">目前：用 /api/events 顯示 CalendarEvents（公司月曆）</span>
    </div>

    <div id="calendar"></div>
    <div id="status"></div>
  </div>

  <script type="module">
    import { fetchJSON, getToken, clearToken } from "./api.js";

    const $ = (id) => document.getElementById(id);
    const meEl = $("me");
    const statusEl = $("status");

    function setStatus(text) {
      statusEl.textContent = text || "";
    }

    async function requireAuth() {
      const t = getToken();
      if (!t) throw new Error("missing token");
      return await fetchJSON("/api/me");
    }

    function toYMD(d) {
      const z = (n) => String(n).padStart(2,"0");
      return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;
    }

    // FullCalendar init
    let calendar;
    function initCalendar() {
      const el = document.getElementById("calendar");
      calendar = new FullCalendar.Calendar(el, {
        initialView: "dayGridMonth",
        height: "auto",
        locale: "zh-tw",
        headerToolbar: {
          left: "prev,next today",
          center: "title",
          right: "dayGridMonth,timeGridWeek,timeGridDay,listWeek"
        },
        events: async (info, success, failure) => {
          try {
            const start = toYMD(info.start);
            const end = toYMD(info.end);
            const data = await fetchJSON(`/api/events?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`);
            const items = data?.items || [];
            const evs = items
              .filter(x => x && x.status !== "deleted")
              .map(x => ({
                id: x.id,
                title: x.title || "",
                start: x.start,
                end: x.end,
                allDay: String(x.all_day).toLowerCase() === "true" || x.all_day === true,
                extendedProps: x
              }));
            setStatus(`載入事件：${evs.length} 筆\n視窗：${start} ~ ${end}`);
            success(evs);
          } catch (e) {
            console.error(e);
            setStatus("載入失敗：" + (e?.message || e));
            failure(e);
          }
        },
        eventClick: (arg) => {
          const x = arg.event.extendedProps || {};
          const lines = [
            `標題：${arg.event.title}`,
            `開始：${arg.event.startStr}`,
            `結束：${arg.event.endStr || ""}`,
            `類型：${x.event_type || ""}`,
            `狀態：${x.status || ""}`,
            `參考：${x.ref_id || ""}`,
            `說明：${x.description || ""}`,
          ];
          alert(lines.join("\n"));
        }
      });
      calendar.render();
    }

    async function boot() {
      try {
        const me = await requireAuth();
        meEl.textContent = `你好：${me?.name_zh || me?.login_name || "user"} (${me?.emp_no || ""}) role=${me?.role || ""}`;
        const isAdmin = String(me?.role || "").toLowerCase() === "admin";
        $("btnAdmin").hidden = !isAdmin;
        $("btnSyncLeave").hidden = !isAdmin;
        $("btnSyncOT").hidden = !isAdmin;
        initCalendar();
      } catch (e) {
        console.error(e);
        clearToken();
        location.replace("./login.html");
      }
    }

    $("btnLogout").onclick = () => {
      clearToken();
      location.replace("./login.html");
    };
    $("btnChangePw").onclick = () => location.href = "./change-password.html";
    $("btnAdmin").onclick = () => location.href = "./admin.html";
    $("btnRefresh").onclick = () => calendar?.refetchEvents();

    // Admin sync buttons (manual)
    async function promptWindow(defaultDays) {
      const start = prompt("start (YYYY-MM-DD)", toYMD(new Date()));
      if (!start) return null;
      const d = new Date(start + "T00:00:00");
      const endD = new Date(d.getTime() + (defaultDays*24*3600*1000));
      const end = prompt("end (YYYY-MM-DD)", toYMD(endD));
      if (!end) return null;
      return {start, end};
    }

    $("btnSyncLeave").onclick = async () => {
      try {
        const w = await promptWindow(7);
        if (!w) return;
        setStatus("同步排假中…");
        const res = await fetchJSON(`/api/sync/leave-events?start=${encodeURIComponent(w.start)}&end=${encodeURIComponent(w.end)}`, { method: "POST" });
        setStatus("✅ 同步排假完成\n" + JSON.stringify(res, null, 2));
        calendar?.refetchEvents();
      } catch (e) {
        setStatus("❌ 同步排假失敗：" + (e?.message || e));
      }
    };

    $("btnSyncOT").onclick = async () => {
      try {
        const w = await promptWindow(7);
        if (!w) return;
        setStatus("同步加班中…");
        const res = await fetchJSON(`/api/sync/overtime-events?start=${encodeURIComponent(w.start)}&end=${encodeURIComponent(w.end)}`, { method: "POST" });
        setStatus("✅ 同步加班完成\n" + JSON.stringify(res, null, 2));
        calendar?.refetchEvents();
      } catch (e) {
        setStatus("❌ 同步加班失敗：" + (e?.message || e));
      }
    };

    boot();
  </script>
</body>
</html>
